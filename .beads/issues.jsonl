{"id":"default-9xm","title":"Homebrew to nix","description":"Migrate packages from Homebrew, in to nix for declarative management, using home manager, pull from hosts/darwin/bobs-laptop\n","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-05T19:57:14.076331-07:00","created_by":"bcotton","updated_at":"2026-01-05T20:44:23.040022-07:00","closed_at":"2026-01-05T20:44:23.040022-07:00","close_reason":"Closed","comments":[{"id":1,"issue_id":"default-9xm","author":"bcotton","text":"Started implementation: Added programs.gh, programs.k9s, programs.thefuck to Home Manager. Added ~25 packages to home.packages. Removed 53 duplicate brews from Homebrew config. Building to test...","created_at":"2026-01-06T03:12:03Z"},{"id":2,"issue_id":"default-9xm","author":"bcotton","text":"Build successful! Added programs.gh, programs.k9s, programs.thefuck as Home Manager modules. Added 23 packages to home.packages. Reduced Homebrew brews from 62 to 10 (keeping macOS-specific and unavailable packages). Ready to switch.","created_at":"2026-01-06T03:18:15Z"},{"id":3,"issue_id":"default-9xm","author":"bcotton","text":"Uninstalled 52 Homebrew packages (now managed by Nix). Also auto-removed 14 unused dependencies. Migration complete!","created_at":"2026-01-06T03:42:49Z"}]}
{"id":"main-f86","title":"nebula-01 Lighthouse Host","description":"Create a new NixOS host `nebula-01` to run a Nebula lighthouse on an ARM64 VPS.\n\n## Current State\n\n- **Nebula source**: Native NixOS module from nixpkgs (`services.nebula.networks.\u003cname\u003e`)\n- **No external flake needed** - Nebula is built into NixOS\n- **Existing VPN**: Tailscale currently used (will keep alongside Nebula)\n\n## Configuration\n\n| Setting | Value |\n|---------|-------|\n| VPS architecture | aarch64-linux (ARM64) |\n| System type | Full (with common packages, Tailscale) |\n| Nebula network name | `clubcotton` |\n| Nebula IP range | 10.42.0.0/24 |\n| Lighthouse IP | 10.42.0.1 |\n| UDP port | 4242 (default) |\n\n## Implementation Steps\n\n### 1. Add host to `flake-modules/hosts.nix`\n\nAdd to `nixosHostSpecs`:\n```nix\nnebula-01 = {\n  system = \"aarch64-linux\";\n  usernames = [\"bcotton\"];\n};\n```\n\n### 2. Create host directory structure\n\n```\nhosts/nixos/nebula-01/\n├── default.nix\n└── hardware-configuration.nix  # Generate on VPS or use disko\n```\n\n### 3. Create `hosts/nixos/nebula-01/default.nix`\n\n```nix\n{ config, pkgs, lib, hostName, ... }:\nlet\n  commonLib = import ../../common/lib.nix;\n  variables = commonLib.getHostVariables hostName;\n  keys = import ../../common/keys.nix;\nin {\n  imports = [ ./hardware-configuration.nix ];\n\n  # Tailscale (for management access)\n  services.clubcotton.tailscale.enable = true;\n\n  # Nebula lighthouse\n  services.nebula.networks.clubcotton = {\n    enable = true;\n    isLighthouse = true;\n    ca = config.age.secrets.nebula-ca-crt.path;\n    cert = config.age.secrets.nebula-01-crt.path;\n    key = config.age.secrets.nebula-01-key.path;\n    listen.port = 4242;\n    settings = {\n      punchy = {\n        punch = true;\n        respond = true;\n      };\n    };\n  };\n\n  # Firewall\n  networking.firewall.allowedUDPPorts = [ 4242 ];\n\n  # Basic services\n  programs.zsh.enable = variables.zshEnable;\n  services.openssh.enable = variables.opensshEnable;\n\n  users.users.root.openssh.authorizedKeys.keys = keys.rootAuthorizedKeys;\n\n  networking = {\n    hostId = variables.hostId;\n    hostName = \"nebula-01\";\n  };\n\n  time.timeZone = variables.timeZone;\n  networking.firewall.enable = variables.firewallEnable;\n  system.stateVersion = variables.stateVersion;\n}\n```\n\n### 4. Add secrets to `secrets/secrets.nix`\n\n```nix\n\"nebula-ca.crt.age\".publicKeys = allKeys;\n\"nebula-01.crt.age\".publicKeys = allKeys;\n\"nebula-01.key.age\".publicKeys = allKeys;\n```\n\n### 5. Reference secrets in host config\n\nAdd to `hosts/nixos/nebula-01/default.nix`:\n```nix\nage.secrets = {\n  nebula-ca-crt.file = ../../../secrets/nebula-ca.crt.age;\n  nebula-01-crt.file = ../../../secrets/nebula-01.crt.age;\n  nebula-01-key.file = ../../../secrets/nebula-01.key.age;\n};\n```\n\n### 6. Generate Nebula certificates (manual step)\n\n```bash\n# Install nebula tools\nnix-shell -p nebula\n\n# Generate CA (do once, keep ca.key VERY safe)\nnebula-cert ca -name \"clubcotton\"\n\n# Generate lighthouse certificate\nnebula-cert sign -name \"nebula-01\" -ip \"10.42.0.1/24\"\n\n# Encrypt with agenix\ncd secrets/\nagenix -e nebula-ca.crt.age    # paste ca.crt contents\nagenix -e nebula-01.crt.age    # paste nebula-01.crt contents\nagenix -e nebula-01.key.age    # paste nebula-01.key contents\n```\n\n## Files to Create/Modify\n\n| File | Action |\n|------|--------|\n| `flake-modules/hosts.nix` | Add nebula-01 to nixosHostSpecs |\n| `hosts/nixos/nebula-01/default.nix` | Create host config |\n| `hosts/nixos/nebula-01/hardware-configuration.nix` | Generate on VPS |\n| `secrets/secrets.nix` | Add nebula secret definitions |\n| `secrets/nebula-ca.crt.age` | Create (CA certificate) |\n| `secrets/nebula-01.crt.age` | Create (lighthouse cert) |\n| `secrets/nebula-01.key.age` | Create (lighthouse key) |\n\n## Deployment\n\n```bash\n# After VPS is provisioned:\nnix run github:nix-community/nixos-anywhere -- --flake '.#nebula-01' root@\u003cvps-ip\u003e\n```\n\n## Verification\n\n1. SSH to nebula-01 via Tailscale\n2. Check Nebula service: `systemctl status nebula@clubcotton`\n3. Verify listening: `ss -ulnp | grep 4242`\n4. Test from another node with Nebula client configured\n\n## Future: Adding Nebula Clients\n\nFor other hosts to join the Nebula network:\n```nix\nservices.nebula.networks.clubcotton = {\n  enable = true;\n  ca = config.age.secrets.nebula-ca-crt.path;\n  cert = config.age.secrets.\"nebula-${hostName}-crt\".path;\n  key = config.age.secrets.\"nebula-${hostName}-key\".path;\n  lighthouses = [ \"10.42.0.1\" ];\n  staticHostMap = {\n    \"10.42.0.1\" = [ \"\u003cvps-public-ip\u003e:4242\" ];\n  };\n};\n```\n\n## Sources\n\n- [NixOS Wiki - Nebula](https://nixos.wiki/wiki/Nebula)\n- [NixOS services.nebula options](https://mynixos.com/nixpkgs/options/services.nebula.networks.%3Cname%3E)\n- [nixpkgs nebula.nix module](https://github.com/NixOS/nixpkgs/blob/nixos-25.05/nixos/modules/services/networking/nebula.nix)","notes":"## Review Findings (2026-01-27)\n\n### Gaps Identified\n\n1. **Missing variables.nix** - Need to create `hosts/nixos/nebula-01/variables.nix` with stateVersion\n\n2. **Missing secrets/default.nix update** - Secrets need to be added to both:\n   - `secrets/secrets.nix` (encryption keys)\n   - `secrets/default.nix` (runtime loading with permissions)\n\n3. **Secret naming** - Use consistent naming: `nebula-ca-crt.age`, `nebula-01-crt.age`, `nebula-01-key.age`\n\n4. **Network/boot config** - Plan's default.nix missing boot loader and network configuration\n\n5. **First ARM64 host** - This is the first aarch64-linux host in the flake\n\n### Decisions Made\n\n- **VPS Provider**: Oracle Cloud (free tier ARM instances)\n- **Disk Setup**: Disko for declarative partitioning (works with nixos-anywhere)\n\n### Additional Files Needed\n\n| File | Purpose |\n|------|---------|\n| `hosts/nixos/nebula-01/variables.nix` | Host variables (stateVersion) |\n| `hosts/nixos/nebula-01/disko.nix` | Declarative disk partitioning |\n| `secrets/default.nix` | Add nebula secret loading |\n\n### Oracle Cloud Specifics\n\n- Boot: UEFI (use systemd-boot)\n- Network: DHCP from Oracle\n- Disk: Typically /dev/sda for boot volume\n- Shape: VM.Standard.A1.Flex (ARM64)","status":"open","priority":2,"issue_type":"epic","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:57:47.142824421-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T10:21:42.4599254-07:00"}
{"id":"main-f86.1","title":"Add nebula-01 to flake-modules/hosts.nix","description":"Add nebula-01 to nixosHostSpecs in flake-modules/hosts.nix:\n```nix\nnebula-01 = {\n  system = \"aarch64-linux\";\n  usernames = [\"bcotton\"];\n};\n```","status":"closed","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:57:59.391999916-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T10:25:55.931199391-07:00","closed_at":"2026-01-27T10:25:55.931199391-07:00","close_reason":"Added nebula-01 to nixosHostSpecs with system=aarch64-linux","dependencies":[{"issue_id":"main-f86.1","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T08:57:59.392935875-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.10","title":"Add nebula secrets to secrets/default.nix","description":"Add nebula secret definitions to secrets/default.nix for runtime loading.\n\nAdd:\n```nix\nage.secrets.nebula-ca-crt = {\n  file = ./nebula-ca-crt.age;\n};\nage.secrets.nebula-01-crt = {\n  file = ./nebula-01-crt.age;\n};\nage.secrets.nebula-01-key = {\n  file = ./nebula-01-key.age;\n  mode = \"0400\";  # Private key needs restrictive permissions\n};\n```\n\nThis is separate from secrets/secrets.nix which only defines encryption keys.","status":"open","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T10:21:49.640040305-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T10:22:00.229989008-07:00","dependencies":[{"issue_id":"main-f86.10","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T10:21:49.640971365-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.2","title":"Create hosts/nixos/nebula-01/default.nix","description":"Create the main host configuration with:\n- Nebula lighthouse config (services.nebula.networks.clubcotton)\n- Tailscale enabled for management\n- Firewall open UDP 4242\n- Standard variables integration","status":"closed","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:57:59.523431621-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T13:32:43.952999275-07:00","closed_at":"2026-01-27T13:32:43.952999275-07:00","close_reason":"Created default.nix with Nebula lighthouse config, secrets refs, DHCP networking","dependencies":[{"issue_id":"main-f86.2","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T08:57:59.524527755-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.2","depends_on_id":"main-f86.1","type":"blocks","created_at":"2026-01-27T08:58:04.512091194-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.2","depends_on_id":"main-f86.8","type":"blocks","created_at":"2026-01-27T10:22:07.600733452-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.3","title":"Add nebula secrets to secrets/secrets.nix","description":"Add secret definitions:\n- nebula-ca.crt.age (CA certificate)\n- nebula-01.crt.age (lighthouse cert)\n- nebula-01.key.age (lighthouse key)","status":"open","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:57:59.655623738-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T08:57:59.655623738-07:00","dependencies":[{"issue_id":"main-f86.3","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T08:57:59.656679776-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.3","depends_on_id":"main-f86.1","type":"blocks","created_at":"2026-01-27T08:58:04.55943128-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.4","title":"Generate Nebula CA and lighthouse certificates","description":"Manual step - user must:\n1. nix-shell -p nebula\n2. nebula-cert ca -name \"clubcotton\"\n3. nebula-cert sign -name \"nebula-01\" -ip \"10.42.0.1/24\"\n4. Encrypt with agenix (agenix -e \u003cfile\u003e.age)","status":"open","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:57:59.780698435-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T08:57:59.780698435-07:00","dependencies":[{"issue_id":"main-f86.4","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T08:57:59.781526989-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.4","depends_on_id":"main-f86.3","type":"blocks","created_at":"2026-01-27T08:58:04.605235571-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.4","depends_on_id":"main-f86.10","type":"blocks","created_at":"2026-01-27T10:22:09.346154573-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.5","title":"Create hardware-configuration.nix for nebula-01","description":"Either:\n- Generate on VPS with nixos-generate-config, OR\n- Create disko configuration for nixos-anywhere deployment","status":"open","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:57:59.906290922-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T08:57:59.906290922-07:00","dependencies":[{"issue_id":"main-f86.5","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T08:57:59.907112011-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.5","depends_on_id":"main-f86.2","type":"blocks","created_at":"2026-01-27T08:58:04.651369582-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.5","depends_on_id":"main-f86.9","type":"blocks","created_at":"2026-01-27T10:22:08.622452446-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.6","title":"Deploy nebula-01 to VPS","description":"Deploy using nixos-anywhere:\n```bash\nnix run github:nix-community/nixos-anywhere -- --flake '.#nebula-01' root@\u003cvps-ip\u003e\n```","status":"open","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:58:00.03358985-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T08:58:00.03358985-07:00","dependencies":[{"issue_id":"main-f86.6","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T08:58:00.034682277-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.6","depends_on_id":"main-f86.4","type":"blocks","created_at":"2026-01-27T08:58:04.698894991-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.6","depends_on_id":"main-f86.5","type":"blocks","created_at":"2026-01-27T08:58:04.744188987-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.7","title":"Verify nebula-01 lighthouse is running","description":"Verification steps:\n1. SSH to nebula-01 via Tailscale\n2. systemctl status nebula@clubcotton\n3. ss -ulnp | grep 4242\n4. Test from another node with Nebula client","status":"open","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:58:00.160955996-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T08:58:00.160955996-07:00","dependencies":[{"issue_id":"main-f86.7","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T08:58:00.161903837-07:00","created_by":"Bob Cotton"},{"issue_id":"main-f86.7","depends_on_id":"main-f86.6","type":"blocks","created_at":"2026-01-27T08:58:04.791547889-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.8","title":"Create hosts/nixos/nebula-01/variables.nix","description":"Create the variables.nix file for nebula-01 following the pattern of other hosts.\n\nContent:\n```nix\n{ stateVersion = \"24.11\"; }\n```\n\nThis file is required by commonLib.getHostVariables and all NixOS hosts have one.","status":"closed","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T10:21:49.395579095-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T10:37:51.775386301-07:00","closed_at":"2026-01-27T10:37:51.775386301-07:00","close_reason":"Created variables.nix with stateVersion 24.11","dependencies":[{"issue_id":"main-f86.8","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T10:21:49.396519773-07:00","created_by":"Bob Cotton"}]}
{"id":"main-f86.9","title":"Create hosts/nixos/nebula-01/disko.nix for disk partitioning","description":"Create declarative disk partitioning config for Oracle Cloud ARM instance.\n\nRequirements:\n- UEFI boot (Oracle Cloud uses UEFI)\n- Single disk layout (typically /dev/sda)\n- Root partition with ext4 or btrfs\n- ESP partition for systemd-boot\n\nReference existing disko configs in the repo or nixos-anywhere examples.","status":"open","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T10:21:49.517977906-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T10:22:00.106973178-07:00","dependencies":[{"issue_id":"main-f86.9","depends_on_id":"main-f86","type":"parent-child","created_at":"2026-01-27T10:21:49.519253154-07:00","created_by":"Bob Cotton"}]}
{"id":"main-phx","title":"testing","status":"tombstone","priority":2,"issue_type":"task","owner":"bob.cotton@gmail.com","created_at":"2026-01-27T08:54:57.382369417-07:00","created_by":"Bob Cotton","updated_at":"2026-01-27T08:55:41.938019534-07:00","deleted_at":"2026-01-27T08:55:41.938019534-07:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
