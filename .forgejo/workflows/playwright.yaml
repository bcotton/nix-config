name: Playwright Tests

on:
  push:
    branches:
      - main
      - playwrite-in-nix
      - playwrite-cli-tests
  pull_request:
  workflow_dispatch:

jobs:
  playwright:
    runs-on: ubuntu-latest
    container:
      image: forgejo.bobtail-clownfish.ts.net/bcotton/nix-ci-runner:fe32792
      options: --user root --ipc=host
    steps:
      - name: Setup Nix environment
        run: |
          git config --global user.email "actions@forgejo.local"
          git config --global user.name "Forgejo Actions"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup smoke test credentials
        run: |
          echo "${{ secrets.SMOKE_TEST_CREDS }}" > shells/playwright/.env

      - name: Enter Playwright shell and run tests
        timeout-minutes: 10
        run: |
          cd shells/playwright
          nix develop --command bash -c '
            echo "=== Playwright Environment ==="
            echo "Node version: $(node --version)"
            echo "Browser path: $PLAYWRIGHT_BROWSERS_PATH"
            echo "SSL_CERT_FILE: ${SSL_CERT_FILE:-unset}"
            echo ""

            # Install npm dependencies
            npm ci

            # Quick diagnostic: test Chromium navigation with verbose logging
            timeout 60 node -e "
              const pw = require(\"playwright-core\");
              (async () => {
                console.log(\"Launching Chromium with verbose logging...\");
                const browser = await pw.chromium.launch({
                  args: [\"--no-sandbox\", \"--disable-setuid-sandbox\",
                         \"--disable-dev-shm-usage\", \"--disable-gpu\",
                         \"--enable-logging=stderr\", \"--v=1\"]
                });
                const page = await browser.newPage({ ignoreHTTPSErrors: true });

                // Test 1: data URL (no network)
                await page.goto(\"data:text/html,<h1>test</h1>\");
                console.log(\"TEST data: OK, url=\", page.url());

                // Test 2: HTTP (not HTTPS) - test network without TLS
                try {
                  const r = await page.goto(\"http://httpbin.org/get\", { timeout: 15000 });
                  console.log(\"TEST http: status=\", r?.status(), \"url=\", page.url());
                } catch(e) { console.log(\"TEST http FAILED:\", e.message.split(\"\\\n\")[0]); }

                // Test 3: HTTPS
                try {
                  const r = await page.goto(\"https://httpbin.org/get\", { timeout: 15000 });
                  console.log(\"TEST https: status=\", r?.status(), \"url=\", page.url());
                } catch(e) { console.log(\"TEST https FAILED:\", e.message.split(\"\\\n\")[0]); }

                await browser.close();
                console.log(\"Diagnostic done.\");
              })().catch(e => console.error(\"FATAL:\", e.message));
            " 2>&1 | grep -E 'TEST |FATAL|Launching|Diagnostic|ERROR|CRASH|crash|nss|ssl|cert|NSS' || true
            echo ""

            # Run only navidrome tests for CI debugging
            node node_modules/@playwright/test/cli.js test \
              --project=setup-navidrome --project=navidrome
          '

